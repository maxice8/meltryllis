#!/bin/sh
# SPDX-License-Identifier: GPL-3.0-only
# mgbr BRANCH-NAME ... - mgbr merge branches
[ $# -lt 1 ] && set -- $(git current-branch)

set -e

# If we have more than one branch given to us then create a temporary branch that
# holds all the commits and push it all at once
if [ "$#" -gt 1 ]; then
	branch="$1"-"$(</dev/urandom tr -dc A-Za-z0-9-_ | dd bs=22 count=1 2>/dev/null)"
	git switch --force-create "$branch" origin/master
	
	git merge "$@" --no-edit --ff
else
	git switch "$@"
fi

pullp # Pull changes from where we are going to push
pushp # Push our local changes

dlbr "$@" &
test -n "$branch" && { git checkout master ; git branch -D "$branch" & }

wait
