#!/usr/bin/env ash
# shellcheck shell=sh
mute_color="%{F#65737E}"
mute_icon="%"

icon_color="%{F#67b36f}"
soft_color="%{F#32CD32}"
loud_color="%{F#FFFF33}"
warn_color="%{F#ff8c00}"
max_color="%{F#8b0000}"
reset_color="%{F-}"
icon="%{T1}${icon_color} %{T-}"
indicator="${reset_color}"

follow-pulse | grep --line-buffered . | while read -r vol; do
	# Make a subshell so the values when muted don't spill over
	# the global variables
	(
	if echo "$vol" | grep -Fq '!'; then
		# Remove the ! character
		vol="${vol%%!*}"
	
		# Set the other icons to mute values
		icon="%{T1}$mute_color$mute_icon%{T-} "
		soft_color=$mute_color
		loud_color=$mute_color
		warn_color=$mute_color
		max_color=$mute_color
	fi

	case "$vol" in
		[0-9])
		echo -n "${icon} %{T4}${indicator}━━━━━━━━━%{T-}"
		;;
		1[0-5])
		echo -n "${icon} %{T4}${soft_color}━${indicator}━━━━━━━━%{T-}"
		;;
		1[6-9])
		echo -n "${icon} %{T4}${soft_color}━━${indicator}━━━━━━━%{T-}"
		;;
		2[0-4])
		echo -n "${icon} %{T4}${soft_color}━━━${indicator}━━━━━━%{T-}"
		;;
		2[5-9]|3[0-5])
		echo -n "${icon} %{T4}${soft_color}━━━━${indicator}━━━━━%{T-}"
		;;
		3[6-9]|40)
		echo -n "${icon} %{T4}${loud_color}━━━━${indicator}━━━━━%{T-}"
		;;
		4[1-9])
		echo -n "${icon} %{T4}${loud_color}━━━━━${indicator}━━━━%{T-}"
		;;
		5[0-4])
		echo -n "${icon} %{T4}${loud_color}━━━━━━${indicator}━━━%{T-}"
		;;
		5[5-9])
		echo -n "${icon} %{T4}${loud_color}━━━━━━━${indicator}━━%{T-}"
		;;
		6[0-9]|7[0-9])
		echo -n "${icon} %{T4}${warn_color}━━━━━━━${indicator}━━%{T-}"
		;;
		8[0-4])
		echo -n "${icon} %{T4}${warn_color}━━━━━━━━${indicator}━%{T-}"
		;;
		8[5-9])
		echo -n "${icon} %{T4}${max_color}━━━━━━━━${indicator}━%{T-}"
		;;
		*)
		echo -n "${icon} %{T4}${max_color}━━━━━━━━━${indicator}%{T-}"
		;;
	esac
	echo "  %{T1}$vol%%{T-}"
	)
done
