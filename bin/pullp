#!/bin/sh
_REALBASE="$(tracking-branch)"

remote="$(guess-remote)"
if [ -z "$remote" ]; then
	exit 1
fi

pushmode="$(git config --get push.default)"

branch=""
if [ "$pushmode" = current ]; then
    prefix="$(alpine-stable-prefix "$(git branch --show-current)" )"
    if [ "$prefix" ]; then
		_REALBASE="$prefix"-stable
	else
		_REALBASE=master
	fi
fi

branch="$(git branch --show-current)"

url="$(git config --local remote."$remote".url)"

if [ "$PULLP_DRY_RUN" ]; then
	echo Args: "$@"
	echo Remote Branch: $_REALBASE
	echo Remote: "$remote"
	echo Local Branch: "$branch"
	echo Url: "$url"
	echo FinalCommand: git pull --quiet "$remote" --rebase $_REALBASE
	exit 0
fi

git pull --quiet "$remote" --rebase $_REALBASE && \
	printok "Rebased '$branch' on '$remote/$_REALBASE' from '$url'" || \
	printerr "Failed to rebase '$branch' on '$remote/$_REALBASE' from '$url'"
