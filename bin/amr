#!/bin/sh
max_retries=5
delay_between_tries=4

opts=""
mrs=""
for arg; do
    case "$arg" in
        -*) opts="$opts $arg" ;;
        '') ;;
        *) mrs="$mrs $arg" ;;
    esac
done

[ -n "$mrs" ] || mrs="$(git branch --show-current)"

if [ -n "$AMR_DRY_RUN" ]; then
    printf -- "Merge Requests: !%s\n" $(printf -- "%s" "$mrs")
    printf -- "Opts: %s\n" $(printf -- "%s" "$opts")
    exit 0
fi

mrcount="$(printf -- "%s" "$mrs" | tr ' ' '\n' | wc -l)"
for mr in $mrs; do
    tries=0

    if glab mr rebase "$mr"; then
        while [ $tries -lt $max_retries ]; do
            if glab mr merge "$mr" \
                --when-pipeline-succeeds=$(test $mrcount -lt 2 && echo true || echo false) \
                $opts; then
                break   
            else
                tries=$((tries + 1))
                sleep $delay_between_tries
            fi
        done
    fi
done
