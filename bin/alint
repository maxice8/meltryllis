#!/bin/sh
# alint APKBUILD - scan APKBUILD template for common mistakes
#
# Requires GNU Grep for -P, apk add grep
# SPDX license checking is done if spdx-licenses-list is installed

export LC_ALL=C

scan() {
	local rx="$1" msg="$2"
	grep -P -Hn -e "$rx" "$apkbuild" |
		sed "s/^\([^:]*:[^:]*:\)\(.*\)/\1 $msg/"
}

once() {
	head -n 1
}

variables=$(echo -n "startdir
srcdir
pkgdir
subpkgdir
builddir
arch
depends
depends_dev
checkdepends
giturl
install
.*.pre-install
.*.post-install
.*.pre-upgrade
.*.post-upgrade
.*.pre-deinstall
.*.post-deinstall
install_if
license
makedepends
md5sums
sha256sums
sha512sums
options
pkgdesc
pkggroups
pkgname
pkgrel
pkgusers
pkgver
provides
provider_priority
replaces
replaces_priority
source
subpackages
triggers
url" | tr '\n' '|')

ret=0
for apkbuild; do
	if [ -f "$apkbuild" ]; then
	scan '^[^ =]*=(""|''|)$' "variable set to empty string: \2"
	scan '^(?!\s*('"$variables"'))[^\s=-]+=' \
		 "prefix custom variable with _: \2"
	scan '^  ' "indent with tabs" | once
	scan '[\t ]$' "trailing whitespace"
	scan '[^\\]`' "use \$() instead of backticks"
	if [ -f /usr/share/spdx/license.lst ]; then
		sed -n 's/license="\(.*\)"/\1/p' "$apkbuild" | tr , "\n" | while read -r l; do
			if ! grep -q "^${l}$" /usr/share/spdx/license.lst; then
				scan "license=.*$l" "license '$l' is not SPDX"
			fi
		done
	fi
	else
	echo no such apkbuild "$apkbuild" 1>&2
	fi | sort -t: -n -k2 | grep . && ret=1
done
exit $ret
