#!/bin/bash
append_arg() {
	a="$a $1"
}

a="--bind /awine /" # Mount /awine on our root system as read-only

append_arg "--dir /tmp" # Create a /var directory
append_arg "--ro-bind /sys /sys" # Mount host /sys as read-only
append_arg "--ro-bind /etc/pulse /etc/pulse"
append_arg "--proc /proc" # Create a procfs mount
append_arg "--dev /dev"  # Create a devfs mount
append_arg "--ro-bind /etc/resolv.conf /etc/resolv.conf" # Mount our resolv configuration as read-only
append_arg "--unshare-all" # Unshare all namespaces
append_arg "--die-with-parent" # Kill everything when we exit
append_arg "--tmpfs /run" # Mount /run as an empty tmpfs
append_arg "--bind /tmp/.X11-unix/X0 /tmp/.X11-unix/X0" # Mount the display server as :0 on the machine
append_arg "--dir /run/user/$(id -u)" # Create /run/user/$(id of calling user)
append_arg "--bind /run/user/$(id -u) /run/user/$(id -u)" # And mount it for us
append_arg "--setenv XDG_RUNTIME_DIR /run/user/$(id -u)" # Set XDG_RUNTIME_DIR to the /run/user dir
append_arg "--setenv DISPLAY $DISPLAY" # Set our display
append_arg "--dev-bind /dev/dri /dev/dri" # Share our graphics card
append_arg "--bind /dev/shm /dev/shm"
append_arg "--bind /home /home" # Mount system /home so we can install wine games

# Disable wine debugging for performance
append_arg "--setenv WINEDEBUG -all"

# By default, have win32
append_arg "--setenv WINEARCH win32"

# If $1 is set then we have a custom wineprefix
append_arg "--setenv WINEPREFIX $XDG_DATA_HOME/wine$(test -n "$1" && echo "-$1")"

case "$1" in
	hoi4)
		# hoi4 starting with 1.7.0 (Hybrid) is 64bits
		append_arg "--setenv WINEARCH win64"
		DIR_TO_CHDIR="$XDG_DATA_HOME/wine-hoi4/drive_c/HOI4"
		;;
	aoe)
		# AoE DE requires 64bit
		append_arg "--setenv WINEARCH win64"
		;;
esac

if [ "$2" ]; then
	append_arg "--share-net"
fi

exec bwrap $a --chdir "${DIR_TO_CHDIR:-$PWD}" /bin/bash
